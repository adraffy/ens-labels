<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ENS Labelhash⁻¹</title>
<style>
.hide {
	display: none !important;
}
button {
	cursor: pointer;
	text-decoration: none;
	font-size: 100%;
	padding: 4px 8px;
}
body {
	margin: 3rem;
	background: #eee;
}
header {
	display: flex;
}
header h1 {
	flex: 1;
	margin: 0;
}
h1 .count {
	font-size: 60%;
	font-weight: bold;
}
#github {
	text-align: right;
}
#links {
	margin-top: 4px;
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 4px 8px;
}
#links .code {
	font-family: monospace;
}
#links .file {
	display: flex;
	align-items: baseline;
	gap: 2px;
	text-decoration: none;
}
#links .file code {
	text-decoration: underline;
}
#links .file span {
	font: 70% sans-serif;
	color: #666;
}
#download {
	user-select: none;
}
#input {
	margin-top: 10px;
}
#name_field {
	box-sizing: border-box;
	width: 100%;
	padding: 8px;
	font-size: 16px;
	font-family: monospace;
}
#examples {
	margin-top: 8px;
	display: flex;
	flex-wrap: wrap;
	gap: 4px;
}
#examples button {
	font-size: 90%;
	padding: 3px 6px;
}
#actions {
	display: flex;
	gap: 8px;
	margin-top: 8px;
	padding-top: 8px;
	border-top: 2px solid #fff;
}
main:empty {
	display: none;
}
main {
	margin-top: 16px;
	display: flex;
	flex-direction: column;
	gap: 8px;
	align-items: center;
	justify-content: center;
}
main .tokens {
	font-size: 36px;
}
#name {
	font-size: 24px;
	background-color: #fff;
	padding: 4px 8px;
	border: 1px solid #ccc;
	overflow-y: auto;
	line-break: anywhere;
	max-height: 5rem;
}
.row {
	display: flex;
	gap: 8px;
}
main p {
	text-align: center;
	margin: 0;
}
.status:empty {
	display: none;
}
.status {
	margin-top: 8px;
	padding: 8px 16px;
	font-size: 18px;
}
.status button {
	margin-left: 8px;
}
.status.error {
	background-color: #fcc;
}
#plot {
	display: block;
	max-width: 640px;
	width: 100%;
}
#readme {
	background-color: #ffc;
	padding: 16px;
	padding-left: 36px;
	margin: 0;
	font-size: 18px;
	line-height: 1.7;
	align-self: stretch;
}
#readme button {
	font-size: 80%;
}
#readme code {
	background-color: #cff;
	padding: 1px;
}
#readme .inverse {
	background-color: #afa;
}
textarea {
	margin-top: 16px;
	padding: 8px;
	width: 100%;
	box-sizing: border-box;
	resize: vertical;
	min-height: 5rem;
}
footer {
	margin: 16px 0;
	text-align: center;
	color: #666;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 1rem;
	}
}
</style>
</head>
<body>
<header>
	<h1><a href="https://ens.domains">ENS</a> Labelhash⁻¹<span class="count" title="Number of known (hash, label)-pairs"></span></h1>
	<div id="github">
		<a href="https://github.com/adraffy/ens-labels">adraffy/ens-labels</a>
	</div>
</header>
<div id="links">
	<a href="../ens-normalize.js/test/resolver.html"><b>Resolver</b></a>
	<a href="../ens-normalize.js/test/emoji.html">Emoji</a>
	<a href="../keccak.js/test/demo.html">Keccak Hasher</a>
	<a href="https://raffy.antistupid.com/eth/ens-regs.html">Registrations</a>
	<a href="https://raffy.antistupid.com/eth/ens-renews.html">Renews</a>
	<a href="https://raffy.antistupid.com/eth/ens-exp.html">Expirations</a>
	<a class="file" download href="./labels.json" title="Download labels as JSON"><code>labels.json</code><span>(<!-- size -->42.3MB<!-- /size -->)</span></a> 
	•
	<a href="https://dune.com/ethereumnameservice/Old">Dune</a>
</div>
<div id="examples">
	<button data-hash="0x00000425b4462e19460bedb4bccfcf16d270975ef882f03831bf3d40f7342355">rilxxlir</button>
	<button data-hash="0x0000d9107d07a44f64888c5ecc821b7a8f7059c5c2ee18edfd1c040103f291a4">voicciov</button>
	<button data-hash="0x0001640f2629bb323fca95bc13744478d5307ba0aca6e3a13f803691923ff00d">exrnnrxe</button>
	<button data-hash="0x021cf935dbd31b6824d617240579dd5d943b7a6e2fe19576b0a87683f66c5255">orange-overlord</button>
	<button data-hash="0x0029271c6712c743df20315ce930b37bd5aabcadb870ddf2b7925151c75c57e2">etherscanio</button>
	<button data-hash="0x01626f5a5c7a2123527dce0a49a04d319c7961b20c7727286d8fd15f43f5508f">muchfunwowdoge</button>
	<button data-hash="79233663829379634837589865448569342784712482819484549289560981379859480642508">vitalik</button>
</div>
<div id="actions">
	<button id="hash_btn">Convert Input to Hash</button>
	<span style="flex: 1"></span>
	<button id="hexdec_btn">HEX↔DEC</button>
</div>
<div id="input">
	<input id="name_field" placeholder="Labelhash: 0xHEX or DEC">
</div>
<div class="status" id="download"></div>
<div class="status error" id="search"></div>
<main>
	<ul id="readme">
		<li>Click an <button data-hash="0xf1b63dc799135ed42428eefabf817f11eb3b13a85389643c0c4925e3d2050f71">Example</button> to see how it works.</li>
		<li><b>Labelhash</b> is <a target="_blank" href="../keccak.js/test/demo.html">256-bit Keccak</a> of the label encoded as UTF-8.</li>
		<li>The <b>Token ID</b> of an <a target="_blank" href="https://opensea.io/assets/ethereum/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/79233663829379634837589865448569342784712482819484549289560981379859480642508">.eth ENS ERC-721 NFT</a> is a <b>Labelhash</b>.</li>
		<li><code>f(label) = hash</code> &rarr; <code class="inverse">label ∈ f<sup>-1</sup>(hash)</code></li>
		<li>Add bulk labels below for additional matching.</li>
	</ul>
	<a href="./plot.svg" target="_blank"><img id="plot" src="./plot.svg"></a>
</main>
<textarea placeholder="Additional Labels (separated by whitespace)" rows="10"></textarea>
<footer>Created by <a href="https://twitter.com/adraffy">raffy.eth</a></footer>
<script type="module">
import {keccak} from '../keccak.js/dist/index.min.js';
import {ens_tokenize, ens_beautify, dom_from_tokens, use_default_style} from '../ens-normalize.js/dist/all.min.js';
use_default_style();

const count_span = document.querySelector('h1 .count');
const name_field = document.querySelector('#name_field');
const init_status = document.querySelector('#download');
const search_status = document.querySelector('#search');
const main = document.querySelector('main');
const more_ta = document.querySelector('textarea');
const readme_dom = [...main.childNodes];

const label_map = new Map();

let init;
let current_hash;
let current_label;
let more_timer;

for (let btn of document.querySelectorAll('[data-hash]')) {
	btn.title = btn.dataset.hash;
	btn.addEventListener('click', () => {
		name_field.value = btn.dataset.hash;
		update_hash();
	});
}

name_field.addEventListener('input', update_hash);
more_ta.addEventListener('input', () => {
	if (more_timer) return;
	more_timer = setTimeout(update_more, 100);
});
document.querySelector('#hash_btn').addEventListener('click', () => {
	name_field.value = `0x${add_label(name_field.value.trim())}`;
	update_count();
	update_hash();
});
document.querySelector('#hexdec_btn').addEventListener('click', () => {
	let s = name_field.value.trim();
	if (/^0x[0-9a-f]+$/i.test(s)) {
		name_field.value = BigInt(s).toString();
	} else if (/^\d+$/.test(s)) {
		name_field.value = '0x' + BigInt(s).toString(16).slice(-64).padStart(64, '0');
	}
});

update_hash();
update_more();

function update_more() {
	clearTimeout(more_timer);
	more_timer = null;
	let dirty;
	for (let line of more_ta.value.split(/\s+/)) {
		if (line) {
			add_label(line);
			dirty = true;
		}
	}
	if (dirty) {
		update_search();
		update_count();
	}
}
function update_hash() {
	let hash = name_field.value.trim();
	if (!hash) {
		current_hash = current_label = null;
		main.innerHTML = '';
		main.append(...readme_dom);
		search_status.innerHTML = '';
		return;
	}
	if (!/^(0x[0-9a-f]{64}|\d+)$/i.test(hash)) {
		current_hash = current_label = null
		main.innerHTML = '';
		search_status.innerHTML = '⚠️ Invalid hash format';
		return;
	}
	current_hash = BigInt(hash).toString(16).slice(-64).padStart(64, '0');
	current_label = false;
	search();
}
function update_search() {
	if (current_hash) {
		search();
	}
}
function update_count() {	
	count_span.innerHTML = ` (${label_map.size.toLocaleString()})`;
}

function search() {
	let label = label_map.get(current_hash);
	if (label === current_label) return;
	main.innerHTML = '';
	current_label = label;
	if (typeof label !== 'string') {
		download();
		search_status.innerHTML = `❓️ Unknown hash`;
		if (init_status.isConnected) search_status.innerHTML += '—<i>still hashing</i>';
		search_status.append(create_resolve_btn(`token:0x${current_hash}`, '↩️ Check Subgraph'));
		return;
	}
	search_status.innerHTML = '';
	if (label) {
		main.append(dom_from_tokens(ens_tokenize(label)));
	} else {
		main.innerHTML = `<div class="tokens"><span class="ignored"><i>Empty String</i></span></div>`;
	}

	//let hash_hex = '0x' + current_hash;
	
	// let row_hex = document.createElement('p');
	// row_hex.innerHTML = `<b>Labelhash</b>: <code>${hash_hex}</code>`;
	// main.append(row_hex);

	// let row_dec = document.createElement('p');
	// row_dec.innerHTML = `<b>Token:</b> <code>${BigInt(hash_hex).toString()}</code>`;
	// main.append(row_dec);

	let row = document.createElement('div');
	row.classList.add('row');
	row.append(create_resolve_btn(`${label}.eth`, '↩️ Resolve'));
	if (label) {
		let copy_btn = document.createElement('button');
		copy_btn.innerHTML = 'Copy';
		copy_btn.addEventListener('click', () => {
			navigator.clipboard.writeText(label);
		});
		row.append(copy_btn);
	}
	main.append(row);
}

function download() {
	if (init) return;
	init = true;
	let xhr = new XMLHttpRequest();
	let prog = 0;
	let render_id;
	update();
	xhr.addEventListener('progress', e => {
		prog = 100 * e.loaded / e.total; // this fires way too much
	});
	xhr.addEventListener('load', () => {
		cancelAnimationFrame(render_id);
		try {
			compute_hashes(JSON.parse(xhr.responseText), 0);
		} catch (err) {
			error('Unable to parse labels');
		}
	});
	xhr.addEventListener('error', () => {
		error('Download failed');
	});
	//xhr.open('GET', './old/test-labels.json');
	xhr.open('GET', './labels.json');
	xhr.send();
	function update() {
		render_id = requestAnimationFrame(update);
		init_status.innerHTML = `⏳️ Downloading (${prog.toFixed(0)}%)`;
		init_status.style.background = progress_gradient(prog, '#aaf', '#ccf'); 
		update_search();
	}
	function error(s) {
		cancelAnimationFrame(render_id);
		init_status.classList.add('error');
		init_status.innerHTML = `⚠️ ${error}`;
	}
}

function compute_hashes(labels, i) {
	const N = 4096;
	let p = 100 * i / Math.max(1, labels.length);
	init_status.style.background = progress_gradient(p, '#0e0 ', '#8f8'); 
	init_status.innerHTML = `👨‍💻 Hashing (${p.toFixed(0)}%)`;
	for (let end = Math.min(labels.length, i + N); i < end; i++) {
		add_label(labels[i]);
	}
	if (i < labels.length) {
		setTimeout(() => compute_hashes(labels, i), 0);
	} else {
		current_label = false; // force update
		init_status.remove();
	}
	update_count();
	update_search();
}
function add_label(label) {
	let hash = keccak().update(label).hex;
	label_map.set(hash, label);
	return hash;
}

function create_resolve_btn(label, html) {
	let a = document.createElement('a');
	a.href = `../ens-normalize.js/test/resolver.html#${encodeURIComponent(label)}`;
	a.innerHTML = ``;
	a.target = '_blank';
	let btn = document.createElement('button');
	btn.innerHTML = html;
	a.append(btn);
	return a;
}

function progress_gradient(p, bar, bg = '#ccc') {
	return `linear-gradient(to right, ${bar} ${p}%, ${bg} ${p+0.1}%)`;
}

</script>
</body>
</html>